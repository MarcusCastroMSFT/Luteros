generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model blog_articles {
  id                String          @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  title             String
  slug              String          @unique
  excerpt           String
  content           String
  image             String?
  coverImage        String?
  authorId          String          @db.Uuid
  category          String
  tags              String[]
  metaTitle         String?
  metaDescription   String?
  readTime          Int
  viewCount         Int             @default(0)
  commentCount      Int             @default(0)
  likeCount         Int             @default(0)
  isPublished       Boolean         @default(false)
  publishedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime
  relatedArticleIds String[]        @default([]) @db.Uuid
  accessType        String          @default("free")
  targetAudience    String          @default("general")
  user_profiles     user_profiles   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  blog_comments     blog_comments[]
  blog_likes        blog_likes[]

  @@index([accessType])
  @@index([authorId])
  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@index([isPublished, category])
  @@index([isPublished, publishedAt(sort: Desc)])
  @@index([slug])
  @@index([targetAudience])
}

model blog_comments {
  id            String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  articleId     String        @db.Uuid
  userId        String        @db.Uuid
  content       String
  isPublished   Boolean       @default(true)
  isReported    Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  blog_articles blog_articles @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user_profiles user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([articleId, createdAt(sort: Desc)])
  @@index([userId])
}

model blog_likes {
  id            String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  articleId     String        @db.Uuid
  userId        String        @db.Uuid
  createdAt     DateTime      @default(now())
  blog_articles blog_articles @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user_profiles user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([articleId, userId])
  @@index([articleId])
  @@index([userId])
}

model certificates {
  id                String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  userId            String        @db.Uuid
  courseId          String        @db.Uuid
  certificateNumber String        @unique
  issuedAt          DateTime      @default(now())
  expiresAt         DateTime?
  verificationUrl   String?
  user_profiles     user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([issuedAt(sort: Desc)])
}

model comments {
  id            String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  userId        String        @db.Uuid
  entityType    String
  entityId      String        @db.Uuid
  content       String
  isPublished   Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  user_profiles user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
}

model community_likes {
  id              String          @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  postId          String          @db.Uuid
  userId          String          @db.Uuid
  createdAt       DateTime        @default(now())
  community_posts community_posts @relation(fields: [postId], references: [id], onDelete: Cascade)
  user_profiles   user_profiles   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
}

model community_posts {
  id                String              @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  title             String
  content           String
  userId            String              @db.Uuid
  category          String
  subcategory       String?
  tags              String[]
  isAnonymous       Boolean             @default(false)
  status            CommunityPostStatus @default(ACTIVE)
  isReported        Boolean             @default(false)
  isPinned          Boolean             @default(false)
  viewCount         Int                 @default(0)
  replyCount        Int                 @default(0)
  likeCount         Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  lastReplyAt       DateTime?
  community_likes   community_likes[]
  user_profiles     user_profiles       @relation(fields: [userId], references: [id], onDelete: Cascade)
  community_replies community_replies[]

  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@index([isPinned, createdAt(sort: Desc)])
  @@index([lastReplyAt(sort: Desc)])
  @@index([status])
  @@index([userId])
}

model community_replies {
  id                    String                  @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  postId                String                  @db.Uuid
  userId                String                  @db.Uuid
  content               String
  isAnonymous           Boolean                 @default(false)
  isReported            Boolean                 @default(false)
  likeCount             Int                     @default(0)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  community_posts       community_posts         @relation(fields: [postId], references: [id], onDelete: Cascade)
  user_profiles         user_profiles           @relation(fields: [userId], references: [id], onDelete: Cascade)
  community_reply_likes community_reply_likes[]

  @@index([postId, createdAt])
  @@index([userId])
}

model community_reply_likes {
  id                String            @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  replyId           String            @db.Uuid
  userId            String            @db.Uuid
  createdAt         DateTime          @default(now())
  community_replies community_replies @relation(fields: [replyId], references: [id], onDelete: Cascade)
  user_profiles     user_profiles     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([replyId, userId])
  @@index([userId])
}

model course_progress {
  id               String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  userId           String        @db.Uuid
  courseId         String        @db.Uuid
  completedLessons Int           @default(0)
  totalLessons     Int
  progressPercent  Int           @default(0)
  lastAccessedAt   DateTime      @default(now())
  updatedAt        DateTime
  courses          courses       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user_profiles    user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([lastAccessedAt(sort: Desc)])
}

model courses {
  id               String            @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  title            String
  slug             String            @unique
  description      String
  shortDescription String?
  level            String
  category         String
  language         String            @default("en")
  duration         Int?
  thumbnail        String?
  coverImage       String?
  previewVideo     String?
  instructorId     String            @db.Uuid
  price            Decimal?          @db.Decimal(10, 2)
  discountPrice    Decimal?          @db.Decimal(10, 2)
  isFree           Boolean           @default(false)
  isPublished      Boolean           @default(false)
  publishedAt      DateTime?
  enrollmentCount  Int               @default(0)
  averageRating    Decimal?          @db.Decimal(3, 2)
  reviewCount      Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  course_progress  course_progress[]
  user_profiles    user_profiles     @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  enrollments      enrollments[]
  lessons          lessons[]
  reviews          reviews[]

  @@index([slug])
  @@index([instructorId])
  @@index([category])
  @@index([level])
  @@index([isPublished, publishedAt(sort: Desc)])
  @@index([isPublished, category])
  @@index([createdAt(sort: Desc)])
  @@index([isFree])
}

model enrollments {
  id              String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  userId          String        @db.Uuid
  courseId        String        @db.Uuid
  enrolledAt      DateTime      @default(now())
  completedAt     DateTime?
  expiresAt       DateTime?
  progressPercent Int           @default(0)
  paidAmount      Decimal?      @db.Decimal(10, 2)
  paymentStatus   String?
  courses         courses       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user_profiles   user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([enrolledAt(sort: Desc)])
  @@index([paymentStatus])
}

model event_registrations {
  id            String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  eventId       String        @db.Uuid
  userId        String        @db.Uuid
  registeredAt  DateTime      @default(now())
  attended      Boolean       @default(false)
  paidAmount    Decimal?      @db.Decimal(10, 2)
  paymentStatus String?
  events        events        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user_profiles user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model event_speakers {
  id       String  @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  eventId  String  @db.Uuid
  name     String
  title    String?
  bio      String?
  image    String?
  linkedin String?
  twitter  String?
  website  String?
  order    Int     @default(0)
  events   events  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model events {
  id                  String                @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  title               String
  slug                String                @unique
  description         String
  fullDescription     String?
  location            String
  eventDate           DateTime
  eventTime           String
  duration            Int?
  image               String?
  totalSlots          Int
  cost                Decimal?              @db.Decimal(10, 2)
  isFree              Boolean               @default(false)
  isPublished         Boolean               @default(false)
  isCancelled         Boolean               @default(false)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  event_registrations event_registrations[]
  event_speakers      event_speakers[]

  @@index([createdAt(sort: Desc)])
  @@index([eventDate(sort: Desc)])
  @@index([isCancelled])
  @@index([isFree])
  @@index([isPublished, eventDate(sort: Desc)])
  @@index([slug])
}

model lesson_progress {
  id              String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  userId          String        @db.Uuid
  lessonId        String        @db.Uuid
  isCompleted     Boolean       @default(false)
  completedAt     DateTime?
  watchedDuration Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  lessons         lessons       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user_profiles   user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([lessonId])
  @@index([isCompleted])
}

model lessons {
  id              String            @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  courseId        String            @db.Uuid
  title           String
  description     String?
  content         String?
  videoUrl        String?
  duration        Int?
  order           Int
  sectionTitle    String?
  isPublished     Boolean           @default(false)
  isFree          Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  type            LessonType        @default(video)
  videoProvider   String?
  lesson_progress lesson_progress[]
  courses         courses           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([courseId, order])
  @@index([courseId])
  @@index([isPublished])
}

model notifications {
  id            String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  userId        String        @db.Uuid
  type          String
  title         String
  message       String
  actionUrl     String?
  isRead        Boolean       @default(false)
  readAt        DateTime?
  createdAt     DateTime      @default(now())
  user_profiles user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([userId, isRead])
}

model product_partners {
  id          String     @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  name        String
  slug        String     @unique
  logo        String?
  website     String?
  description String?
  email       String?
  phone       String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  products    products[]

  @@index([isActive])
  @@index([slug])
}

model products {
  id                 String           @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  slug               String           @unique
  title              String
  description        String
  shortDescription   String
  image              String?
  partnerId          String           @db.Uuid
  discountPercentage Int              @default(0)
  discountType       String           @default("percentage")
  originalPrice      Decimal?         @db.Decimal(10, 2)
  discountedPrice    Decimal?         @db.Decimal(10, 2)
  discountAmount     Decimal?         @db.Decimal(10, 2)
  promoCode          String
  category           String
  tags               String[]
  availability       String           @default("all")
  validUntil         DateTime?
  termsAndConditions String?
  howToUse           String[]
  features           String[]
  isActive           Boolean          @default(true)
  isFeatured         Boolean          @default(false)
  usageCount         Int              @default(0)
  maxUsages          Int?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  product_partners   product_partners @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([availability])
  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@index([isActive, category])
  @@index([isActive, isFeatured])
  @@index([partnerId])
  @@index([slug])
}

model reviews {
  id            String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  userId        String        @db.Uuid
  courseId      String        @db.Uuid
  rating        Int
  title         String?
  comment       String?
  isPublished   Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  courses       courses       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user_profiles user_profiles @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([isPublished, createdAt(sort: Desc)])
  @@index([rating])
}

model user_profiles {
  id                    String                  @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  fullName              String?
  displayName           String?
  bio                   String?
  avatar                String?
  phone                 String?
  dateOfBirth           DateTime?
  title                 String?
  company               String?
  website               String?
  linkedin              String?
  twitter               String?
  instagram             String?
  rating                Decimal?                @db.Decimal(3, 2)
  reviewsCount          Int                     @default(0)
  studentsCount         Int                     @default(0)
  coursesCount          Int                     @default(0)
  language              String                  @default("en")
  timezone              String                  @default("UTC")
  emailNotifications    Boolean                 @default(true)
  marketingEmails       Boolean                 @default(false)
  createdAt             DateTime                @default(now())
  updatedAt             DateTime
  lastLoginAt           DateTime?
  blog_articles         blog_articles[]
  blog_comments         blog_comments[]
  blog_likes            blog_likes[]
  certificates          certificates[]
  comments              comments[]
  community_likes       community_likes[]
  community_posts       community_posts[]
  community_replies     community_replies[]
  community_reply_likes community_reply_likes[]
  course_progress       course_progress[]
  courses               courses[]
  enrollments           enrollments[]
  event_registrations   event_registrations[]
  lesson_progress       lesson_progress[]
  notifications         notifications[]
  reviews               reviews[]
  newsletter_campaigns  newsletter_campaigns[]
  system_emails_updated system_email_templates[] @relation("SystemEmailUpdatedBy")

  @@index([createdAt(sort: Desc)])
  @@index([displayName])
  @@index([fullName])
}

model user_roles {
  id        BigInt   @id @default(autoincrement())
  userId    String   @db.Uuid
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([userId, role])
  @@index([userId])
  @@index([role])
}

model newsletter_subscribers {
  id              String    @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  email           String    @unique
  status          NewsletterStatus @default(ACTIVE)
  unsubscribeToken String   @unique @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  source          String?   // Where they signed up from (footer, popup, etc.)
  ipAddress       String?   // For rate limiting and fraud detection
  confirmedAt     DateTime? // Email confirmation timestamp
  unsubscribedAt  DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model newsletter_campaigns {
  id              String    @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  name            String    // Internal name for the campaign
  subject         String    // Email subject line
  previewText     String?   // Preview text shown in email clients
  content         String    // HTML content of the email
  ctaText         String?   // Call to action button text
  ctaUrl          String?   // Call to action URL
  status          CampaignStatus @default(DRAFT)
  errorMessage    String?   // Error message if sending failed
  scheduledAt     DateTime? // When to send (null = manual send)
  sentAt          DateTime? // When it was actually sent
  totalRecipients Int       @default(0)
  sentCount       Int       @default(0)
  failedCount     Int       @default(0)
  createdById     String    @db.Uuid
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  createdBy       user_profiles @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([scheduledAt])
}

enum NewsletterStatus {
  PENDING     // Awaiting email confirmation
  ACTIVE      // Confirmed and receiving emails
  UNSUBSCRIBED
}

enum CampaignStatus {
  DRAFT       // Being edited
  SCHEDULED   // Scheduled to send
  SENDING     // Currently being sent
  SENT        // Successfully sent
  FAILED      // Failed to send
}

enum CommunityPostStatus {
  ACTIVE
  CLOSED
  MODERATION
}

enum LessonType {
  video
  article
  audio
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  TRIAL
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

// System email templates - Configurable templates for transactional emails
model system_email_templates {
  id              String    @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  code            String    @unique // e.g., 'welcome', 'password_reset', 'email_verification'
  name            String    // Display name: "E-mail de Boas-vindas"
  description     String?   // Description of when this email is sent
  category        SystemEmailCategory
  subject         String    // Email subject line
  previewText     String?   // Preview text shown in email clients
  htmlContent     String    // HTML content of the email
  textContent     String?   // Plain text fallback
  variables       String[]  // Available template variables: ['name', 'email', 'link']
  isActive        Boolean   @default(true)
  updatedById     String?   @db.Uuid
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  updatedBy       user_profiles? @relation("SystemEmailUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([category])
  @@index([isActive])
}

enum SystemEmailCategory {
  AUTHENTICATION   // Signup, password reset, email verification
  ACCOUNT          // Account updates, profile changes
  NOTIFICATION     // General notifications
  TRANSACTION      // Purchase confirmations, receipts
  ENGAGEMENT       // Re-engagement, inactive user reminders
}
