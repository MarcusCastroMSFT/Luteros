// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// IMPORTANT: Supabase Auth Integration
// ============================================
// DO NOT duplicate fields from auth.users table
// auth.users already contains: id, email, phone, created_at, updated_at
// We only store additional user profile data here

// User Roles (matches Supabase Auth custom claims)
enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  TRIAL
}

// ============================================
// USER PROFILE (extends auth.users)
// ============================================
model UserProfile {
  id                String   @id @db.Uuid // References auth.users(id)
  
  // Profile Information
  fullName          String?
  displayName       String?
  bio               String?   @db.Text
  avatar            String?
  phone             String?
  dateOfBirth       DateTime?
  
  // Professional Information
  title             String?
  company           String?
  website           String?
  linkedin          String?
  twitter           String?
  instagram         String?
  
  // Stats (for instructors)
  rating            Decimal?  @db.Decimal(3, 2)
  reviewsCount      Int       @default(0)
  studentsCount     Int       @default(0)
  coursesCount      Int       @default(0)
  
  // Preferences
  language          String    @default("en")
  timezone          String    @default("UTC")
  emailNotifications Boolean  @default(true)
  marketingEmails   Boolean   @default(false)
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  
  // Relations - Courses
  enrollments       Enrollment[]
  courseProgress    CourseProgress[]
  lessonProgress    LessonProgress[]
  instructorCourses Course[]  @relation("InstructorCourses")
  reviews           Review[]
  
  // Relations - Blog
  blogArticles      BlogArticle[] @relation("BlogArticles")
  blogComments      BlogComment[] @relation("BlogComments")
  blogLikes         BlogLike[]    @relation("BlogLikes")
  
  // Relations - Events
  eventRegistrations EventRegistration[] @relation("EventRegistrations")
  
  // Relations - Community
  communityPosts    CommunityPost[]      @relation("CommunityPosts")
  communityReplies  CommunityReply[]     @relation("CommunityReplies")
  communityPostLikes CommunityLike[]     @relation("CommunityPostLikes")
  communityReplyLikes CommunityReplyLike[] @relation("CommunityReplyLikes")
  
  // Relations - General
  comments          Comment[]
  certificates      Certificate[]
  notifications     Notification[]
  
  @@index([fullName])
  @@index([displayName])
  @@index([createdAt(sort: Desc)])
  @@map("user_profiles")
}

// User Roles Table (for Supabase Auth Hooks)
model UserRoleAssignment {
  id        BigInt   @id @default(autoincrement())
  userId    String   @db.Uuid
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, role])
  @@map("user_roles")
}

// ============================================
// COURSES
// ============================================
model Course {
  id               String   @id @default(uuid()) @db.Uuid
  
  // Basic Information
  title            String
  slug             String   @unique
  description      String   @db.Text
  shortDescription String?
  
  // Course Details
  level            String   // BEGINNER, INTERMEDIATE, ADVANCED
  category         String
  language         String   @default("en")
  duration         Int?     // in minutes
  
  // Media
  thumbnail        String?
  coverImage       String?
  previewVideo     String?
  
  // Instructor
  instructorId     String   @db.Uuid
  instructor       UserProfile @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Cascade)
  
  // Pricing
  price            Decimal? @db.Decimal(10, 2)
  discountPrice    Decimal? @db.Decimal(10, 2)
  isFree           Boolean  @default(false)
  
  // Status
  isPublished      Boolean  @default(false)
  publishedAt      DateTime?
  
  // Stats
  enrollmentCount  Int      @default(0)
  averageRating    Decimal? @db.Decimal(3, 2)
  reviewCount      Int      @default(0)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  lessons          Lesson[]
  enrollments      Enrollment[]
  reviews          Review[]
  courseProgress   CourseProgress[]
  
  @@map("courses")
}

// ============================================
// LESSONS
// ============================================
model Lesson {
  id               String   @id @default(uuid()) @db.Uuid
  
  // Basic Information
  courseId         String   @db.Uuid
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  title            String
  description      String?  @db.Text
  
  // Content
  content          String?  @db.Text
  videoUrl         String?
  duration         Int?     // in seconds
  
  // Order
  order            Int
  sectionTitle     String?
  
  // Status
  isPublished      Boolean  @default(false)
  isFree           Boolean  @default(false)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  lessonProgress   LessonProgress[]
  
  @@unique([courseId, order])
  @@map("lessons")
}

// ============================================
// ENROLLMENTS & PROGRESS
// ============================================
model Enrollment {
  id               String   @id @default(uuid()) @db.Uuid
  
  userId           String   @db.Uuid
  user             UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courseId         String   @db.Uuid
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Enrollment Details
  enrolledAt       DateTime @default(now())
  completedAt      DateTime?
  expiresAt        DateTime?
  
  // Progress
  progressPercent  Int      @default(0)
  
  // Payment
  paidAmount       Decimal? @db.Decimal(10, 2)
  paymentStatus    String?  // PENDING, COMPLETED, REFUNDED
  
  @@unique([userId, courseId])
  @@map("enrollments")
}

model CourseProgress {
  id               String   @id @default(uuid()) @db.Uuid
  
  userId           String   @db.Uuid
  user             UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courseId         String   @db.Uuid
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Progress
  completedLessons Int      @default(0)
  totalLessons     Int
  progressPercent  Int      @default(0)
  
  // Time Tracking
  lastAccessedAt   DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([userId, courseId])
  @@map("course_progress")
}

model LessonProgress {
  id               String   @id @default(uuid()) @db.Uuid
  
  userId           String   @db.Uuid
  user             UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  lessonId         String   @db.Uuid
  lesson           Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  // Progress
  isCompleted      Boolean  @default(false)
  completedAt      DateTime?
  watchedDuration  Int      @default(0) // in seconds
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

// ============================================
// REVIEWS & RATINGS
// ============================================
model Review {
  id               String   @id @default(uuid()) @db.Uuid
  
  userId           String   @db.Uuid
  user             UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courseId         String   @db.Uuid
  course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  // Review Content
  rating           Int      // 1-5
  title            String?
  comment          String?  @db.Text
  
  // Moderation
  isPublished      Boolean  @default(true)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([userId, courseId])
  @@map("reviews")
}

// ============================================
// COMMENTS
// ============================================
model Comment {
  id               String   @id @default(uuid()) @db.Uuid
  
  userId           String   @db.Uuid
  user             UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Comment can be on different entities
  entityType       String   // COURSE, LESSON, BLOG_POST
  entityId         String   @db.Uuid
  
  // Content
  content          String   @db.Text
  
  // Moderation
  isPublished      Boolean  @default(true)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("comments")
}

// ============================================
// CERTIFICATES
// ============================================
model Certificate {
  id               String   @id @default(uuid()) @db.Uuid
  
  userId           String   @db.Uuid
  user             UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courseId         String   @db.Uuid
  
  // Certificate Details
  certificateNumber String  @unique
  issuedAt         DateTime @default(now())
  expiresAt        DateTime?
  
  // Verification
  verificationUrl  String?
  
  @@unique([userId, courseId])
  @@map("certificates")
}

// ============================================
// NOTIFICATIONS
// ============================================
model Notification {
  id               String   @id @default(uuid()) @db.Uuid
  
  userId           String   @db.Uuid
  user             UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification Details
  type             String   // COURSE_UPDATE, NEW_LESSON, CERTIFICATE, etc.
  title            String
  message          String   @db.Text
  
  // Link
  actionUrl        String?
  
  // Status
  isRead           Boolean  @default(false)
  readAt           DateTime?
  
  // Metadata
  createdAt        DateTime @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

// ============================================
// BLOG & ARTICLES
// ============================================
model BlogArticle {
  id               String   @id @default(uuid()) @db.Uuid
  
  // Basic Information
  title            String
  slug             String   @unique
  excerpt          String   @db.Text
  content          String   @db.Text
  
  // Media
  image            String?
  coverImage       String?
  
  // Author
  authorId         String   @db.Uuid
  author           UserProfile @relation("BlogArticles", fields: [authorId], references: [id], onDelete: Cascade)
  
  // Categorization
  category         String
  tags             String[] // Array of tags
  
  // Related Content
  relatedArticleIds String[] @default([]) @db.Uuid // Up to 3 related article IDs
  
  // SEO
  metaTitle        String?
  metaDescription  String?
  
  // Stats
  readTime         Int      // in minutes
  viewCount        Int      @default(0)
  commentCount     Int      @default(0)
  likeCount        Int      @default(0)
  
  // Access Control
  accessType       String   @default("free") // free, paid
  targetAudience   String   @default("general") // general, doctors
  
  // Status
  isPublished      Boolean  @default(false)
  publishedAt      DateTime?
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  comments         BlogComment[]
  likes            BlogLike[]
  
  @@index([slug])
  @@index([authorId])
  @@index([category])
  @@index([isPublished, publishedAt(sort: Desc)])
  @@index([isPublished, category]) // For filtering published articles by category
  @@index([createdAt(sort: Desc)])
  @@index([accessType]) // For filtering by free/paid
  @@index([targetAudience]) // For filtering by audience type
  @@map("blog_articles")
}

model BlogComment {
  id               String   @id @default(uuid()) @db.Uuid
  
  articleId        String   @db.Uuid
  article          BlogArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  userId           String   @db.Uuid
  user             UserProfile @relation("BlogComments", fields: [userId], references: [id], onDelete: Cascade)
  
  content          String   @db.Text
  
  // Moderation
  isPublished      Boolean  @default(true)
  isReported       Boolean  @default(false)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([articleId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("blog_comments")
}

model BlogLike {
  id               String   @id @default(uuid()) @db.Uuid
  
  articleId        String   @db.Uuid
  article          BlogArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  
  userId           String   @db.Uuid
  user             UserProfile @relation("BlogLikes", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt        DateTime @default(now())
  
  @@unique([articleId, userId])
  @@index([articleId])
  @@index([userId])
  @@map("blog_likes")
}

// ============================================
// EVENTS
// ============================================
model Event {
  id               String   @id @default(uuid()) @db.Uuid
  
  // Basic Information
  title            String
  slug             String   @unique
  description      String   @db.Text
  fullDescription  String?  @db.Text
  
  // Event Details
  location         String
  eventDate        DateTime
  eventTime        String
  duration         Int?     // in minutes
  
  // Media
  image            String?
  
  // Capacity
  totalSlots       Int
  
  // Pricing
  cost             Decimal? @db.Decimal(10, 2)
  isFree           Boolean  @default(false)
  
  // Status
  isPublished      Boolean  @default(false)
  isCancelled      Boolean  @default(false)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  registrations    EventRegistration[]
  speakers         EventSpeaker[]
  
  @@index([slug])
  @@index([eventDate(sort: Desc)])
  @@index([isPublished, eventDate(sort: Desc)])
  @@index([isFree]) // For filtering free/paid events
  @@index([isCancelled]) // For filtering active events
  @@index([createdAt(sort: Desc)])
  @@map("events")
}

model EventRegistration {
  id               String   @id @default(uuid()) @db.Uuid
  
  eventId          String   @db.Uuid
  event            Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId           String   @db.Uuid
  user             UserProfile @relation("EventRegistrations", fields: [userId], references: [id], onDelete: Cascade)
  
  // Registration Details
  registeredAt     DateTime @default(now())
  attended         Boolean  @default(false)
  
  // Payment
  paidAmount       Decimal? @db.Decimal(10, 2)
  paymentStatus    String?  // PENDING, COMPLETED, REFUNDED
  
  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@map("event_registrations")
}

model EventSpeaker {
  id               String   @id @default(uuid()) @db.Uuid
  
  eventId          String   @db.Uuid
  event            Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  // Speaker Information
  name             String
  title            String?
  bio              String?  @db.Text
  image            String?
  
  // Social Links
  linkedin         String?
  twitter          String?
  website          String?
  
  // Order
  order            Int      @default(0)
  
  @@index([eventId])
  @@map("event_speakers")
}

// ============================================
// COMMUNITY
// ============================================
enum CommunityPostStatus {
  ACTIVE
  CLOSED
  MODERATION
}

model CommunityPost {
  id               String   @id @default(uuid()) @db.Uuid
  
  // Basic Information
  title            String
  content          String   @db.Text
  
  userId           String   @db.Uuid
  user             UserProfile @relation("CommunityPosts", fields: [userId], references: [id], onDelete: Cascade)
  
  // Categorization
  category         String
  subcategory      String?
  tags             String[] // Array of tags
  
  // Privacy
  isAnonymous      Boolean  @default(false)
  
  // Status
  status           CommunityPostStatus @default(ACTIVE)
  
  // Moderation
  isReported       Boolean  @default(false)
  isPinned         Boolean  @default(false)
  
  // Stats
  viewCount        Int      @default(0)
  replyCount       Int      @default(0)
  likeCount        Int      @default(0)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  lastReplyAt      DateTime?
  
  // Relations
  replies          CommunityReply[]
  likes            CommunityLike[]
  
  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([isPinned, createdAt(sort: Desc)])
  @@index([lastReplyAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("community_posts")
}

model CommunityReply {
  id               String   @id @default(uuid()) @db.Uuid
  
  postId           String   @db.Uuid
  post             CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId           String   @db.Uuid
  user             UserProfile @relation("CommunityReplies", fields: [userId], references: [id], onDelete: Cascade)
  
  content          String   @db.Text
  
  // Privacy
  isAnonymous      Boolean  @default(false)
  
  // Moderation
  isReported       Boolean  @default(false)
  
  // Stats
  likeCount        Int      @default(0)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  likes            CommunityReplyLike[]
  
  @@index([postId, createdAt])
  @@index([userId])
  @@map("community_replies")
}

model CommunityLike {
  id               String   @id @default(uuid()) @db.Uuid
  
  postId           String   @db.Uuid
  post             CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId           String   @db.Uuid
  user             UserProfile @relation("CommunityPostLikes", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt        DateTime @default(now())
  
  @@unique([postId, userId])
  @@index([postId])
  @@map("community_likes")
}

model CommunityReplyLike {
  id               String   @id @default(uuid()) @db.Uuid
  
  replyId          String   @db.Uuid
  reply            CommunityReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  
  userId           String   @db.Uuid
  user             UserProfile @relation("CommunityReplyLikes", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt        DateTime @default(now())
  
  @@unique([replyId, userId])
  @@index([replyId])
  @@map("community_reply_likes")
}

// ============================================
// PRODUCTS & PARTNERS
// ============================================
model ProductPartner {
  id               String   @id @default(uuid()) @db.Uuid
  
  // Basic Info
  name             String
  slug             String   @unique
  logo             String?
  website          String?
  description      String?  @db.Text
  
  // Contact
  email            String?
  phone            String?
  
  // Status
  isActive         Boolean  @default(true)
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  // Relations
  products         Product[]
  
  @@index([slug])
  @@index([isActive])
  @@map("product_partners")
}

model Product {
  id               String   @id @default(uuid()) @db.Uuid
  
  // Basic Info
  slug             String   @unique
  title            String
  description      String   @db.Text
  shortDescription String   @db.Text
  image            String?
  
  // Partner relationship
  partnerId        String   @db.Uuid
  partner          ProductPartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  // Discount information (stored as JSON for flexibility)
  discountPercentage Int      @default(0)
  discountType     String   @default("percentage") // percentage, fixed
  originalPrice    Decimal? @db.Decimal(10, 2)
  discountedPrice  Decimal? @db.Decimal(10, 2)
  discountAmount   Decimal? @db.Decimal(10, 2)
  
  // Promo details
  promoCode        String
  
  // Categorization
  category         String
  tags             String[] // Array of tags
  
  // Access Control
  availability     String   @default("all") // all, members
  
  // Validity
  validUntil       DateTime?
  
  // Terms and Usage
  termsAndConditions String? @db.Text
  howToUse         String[] // Array of usage steps
  features         String[] // Array of features
  
  // Status
  isActive         Boolean  @default(true)
  isFeatured       Boolean  @default(false)
  
  // Usage stats
  usageCount       Int      @default(0)
  maxUsages        Int?
  
  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([slug])
  @@index([partnerId])
  @@index([category])
  @@index([isActive, isFeatured])
  @@index([isActive, category])
  @@index([availability])
  @@index([createdAt(sort: Desc)])
  @@map("products")
}
